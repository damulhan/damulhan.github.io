<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>클로저 응용프로그램 구조화 전략 (A Strategy on Structuring Clojure Applications) | 프로그래밍 인 액션</title>
    <meta name="generator" content="VuePress 1.9.9">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-FZZE483ETN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-FZZE483ETN');
    </script>
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.17886239.css" as="style"><link rel="preload" href="/assets/js/app.e020f7bd.js" as="script"><link rel="preload" href="/assets/js/8.f8a27090.js" as="script"><link rel="preload" href="/assets/js/47.f22eedc4.js" as="script"><link rel="prefetch" href="/assets/js/10.6fce9f60.js"><link rel="prefetch" href="/assets/js/11.2d17f5eb.js"><link rel="prefetch" href="/assets/js/12.bf59733f.js"><link rel="prefetch" href="/assets/js/13.a8b52d9b.js"><link rel="prefetch" href="/assets/js/14.c4af07a0.js"><link rel="prefetch" href="/assets/js/15.3d856255.js"><link rel="prefetch" href="/assets/js/16.588eccab.js"><link rel="prefetch" href="/assets/js/17.24b16851.js"><link rel="prefetch" href="/assets/js/18.a6039819.js"><link rel="prefetch" href="/assets/js/19.a4250e41.js"><link rel="prefetch" href="/assets/js/2.2e88546e.js"><link rel="prefetch" href="/assets/js/20.9ec3356e.js"><link rel="prefetch" href="/assets/js/21.c9b3acba.js"><link rel="prefetch" href="/assets/js/22.9f604d6b.js"><link rel="prefetch" href="/assets/js/23.40204a70.js"><link rel="prefetch" href="/assets/js/24.676de2f8.js"><link rel="prefetch" href="/assets/js/25.b990bbc9.js"><link rel="prefetch" href="/assets/js/26.e1d6b8b2.js"><link rel="prefetch" href="/assets/js/27.f39b7922.js"><link rel="prefetch" href="/assets/js/28.85f2eea3.js"><link rel="prefetch" href="/assets/js/29.f4594166.js"><link rel="prefetch" href="/assets/js/3.50da57f6.js"><link rel="prefetch" href="/assets/js/30.a6760802.js"><link rel="prefetch" href="/assets/js/31.338010b8.js"><link rel="prefetch" href="/assets/js/32.e6b70ee6.js"><link rel="prefetch" href="/assets/js/33.59c1939e.js"><link rel="prefetch" href="/assets/js/34.583faad6.js"><link rel="prefetch" href="/assets/js/35.2284c2f2.js"><link rel="prefetch" href="/assets/js/36.5c184555.js"><link rel="prefetch" href="/assets/js/37.211de6f3.js"><link rel="prefetch" href="/assets/js/38.d5267f05.js"><link rel="prefetch" href="/assets/js/39.a4f11fcb.js"><link rel="prefetch" href="/assets/js/4.8b550d71.js"><link rel="prefetch" href="/assets/js/40.fce01b66.js"><link rel="prefetch" href="/assets/js/41.f6faa401.js"><link rel="prefetch" href="/assets/js/42.9526cc90.js"><link rel="prefetch" href="/assets/js/43.596505b1.js"><link rel="prefetch" href="/assets/js/44.7bb9afee.js"><link rel="prefetch" href="/assets/js/45.89ab27ec.js"><link rel="prefetch" href="/assets/js/46.798fa05d.js"><link rel="prefetch" href="/assets/js/48.4e539c23.js"><link rel="prefetch" href="/assets/js/49.e0dcf2cc.js"><link rel="prefetch" href="/assets/js/5.c77d8215.js"><link rel="prefetch" href="/assets/js/50.8fd5c00e.js"><link rel="prefetch" href="/assets/js/51.10a49966.js"><link rel="prefetch" href="/assets/js/52.c24c9aa6.js"><link rel="prefetch" href="/assets/js/53.74e79606.js"><link rel="prefetch" href="/assets/js/54.a3a328dc.js"><link rel="prefetch" href="/assets/js/55.0a3d399c.js"><link rel="prefetch" href="/assets/js/56.2f14e2d2.js"><link rel="prefetch" href="/assets/js/57.6c246fdc.js"><link rel="prefetch" href="/assets/js/58.4140c313.js"><link rel="prefetch" href="/assets/js/59.01d487f7.js"><link rel="prefetch" href="/assets/js/6.a6e440e7.js"><link rel="prefetch" href="/assets/js/60.0446ff28.js"><link rel="prefetch" href="/assets/js/61.d5b6b1a7.js"><link rel="prefetch" href="/assets/js/62.dc942955.js"><link rel="prefetch" href="/assets/js/63.67a66c62.js"><link rel="prefetch" href="/assets/js/64.5a331cdf.js"><link rel="prefetch" href="/assets/js/65.5e04463c.js"><link rel="prefetch" href="/assets/js/66.cc32db40.js"><link rel="prefetch" href="/assets/js/67.3a6502c7.js"><link rel="prefetch" href="/assets/js/68.e543b947.js"><link rel="prefetch" href="/assets/js/69.c6c56c1c.js"><link rel="prefetch" href="/assets/js/7.fb50de22.js"><link rel="prefetch" href="/assets/js/70.4f7ed14a.js"><link rel="prefetch" href="/assets/js/71.8cf0b0df.js"><link rel="prefetch" href="/assets/js/9.c9de3d13.js">
    <link rel="stylesheet" href="/assets/css/0.styles.17886239.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">프로그래밍 인 액션</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/clojure/" class="nav-link router-link-active">
  Clojure
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/clojure/" class="nav-link router-link-active">
  Clojure
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>clojure books</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/clojure/clojure_distilled" class="sidebar-heading clickable open"><span>Clojure 증류하기 (Clojure Distilled)</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/clojure/clojure_distilled/01-Intro.html" class="sidebar-link">서문</a></li><li><a href="/clojure/clojure_distilled/02-Immutable.html" class="sidebar-link">함수형 언어의 이점</a></li><li><a href="/clojure/clojure_distilled/11-Clojure_In_Action.html" class="sidebar-link">클로저 인 액션(Clojure In Action)</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/clojure/clojure_spells" class="sidebar-heading clickable"><span>Clojure로 주문읽기(casting spells in clojure)</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>7 days of clojure</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>columns &amp; lectures</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/clojure/columns/Advantages_Of_Data_Oriented_Programming.html" class="sidebar-link">데이터 지향 프로그래밍의 장점</a></li><li><a href="/clojure/columns/a_strategy_on_structuring_clojure_application.html" aria-current="page" class="active sidebar-link">클로저 응용프로그램 구조화 전략 (A Strategy on Structuring Clojure Applications)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/clojure/talks/Hickey_Rich/AreWeThereYet_ko.html" class="sidebar-link">우리는 거기에 있는가? (Are We There Yet?)</a></li><li><a href="/clojure/talks/Hickey_Rich/PersistentDataStructure_ko.html" class="sidebar-link">영구 데이터 구조 및 관리되는 참조 (Persistent Data Structures and Managed References)</a></li><li><a href="/clojure/talks/Sierra_Stuart/Components.html" class="sidebar-link">Component 충분한 구조 (Components Just Enough Structure)</a></li><li><a href="/clojure/talks/Hickey_Rich/Transducers_ko.html" class="sidebar-link">트랜스듀서(Transducers)</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>talks</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="클로저-응용프로그램-구조화-전략-a-strategy-on-structuring-clojure-applications"><a href="#클로저-응용프로그램-구조화-전략-a-strategy-on-structuring-clojure-applications" class="header-anchor">#</a> 클로저 응용프로그램 구조화 전략 (A Strategy on Structuring Clojure Applications)</h1> <p>(원제: Structuring Clojure Applications)</p> <p>이 글에서는 제 프로젝트에서 유용하게 사용한 Clojure 애플리케이션 구조화 전략을 살펴보겠습니다.</p> <p>순수한 기능 스타일로 애플리케이션을 작성한다는 아이디어는 매력적이지만, 실제로는 순수한 연산과 부작용을 분리하는 방법이 항상 명확하지는 않습니다. 이러한 목표를 달성하기 위한 방법으로 <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html" target="_blank" rel="noopener noreferrer">클린 아키텍처<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>의 변형된 접근 방식이 종종 제안됩니다. 이 방식은 애플리케이션의 순수 연산 코어를 감싸는 외부 레이어에서 IO를 처리해야 한다는 것입니다.</p> <p>이 개념은 매력적이지만, 연산할 데이터의 총량을 미리 알 수 있는 경우에만 효과가 있습니다. 안타깝게도 대부분의 실제 애플리케이션에서 어떤 데이터가 필요한지 미리 파악하는 것은 불가능합니다. 대부분의 경우 입력 유형과 현재 처리 상태에 따라 조건부로 추가 데이터를 로드해야 하는 경우가 많습니다.</p> <p>하지만 <strong>우리가 할 수 있는 일은 애플리케이션을 개별적으로 추론할 수 있는 작은 구성 요소로 분리하는 것입니다. 그런 다음 이러한 구성 요소를 함께 구성하여 더 복잡한 작업을 수행할 수 있습니다</strong>. 저는 이것을 소프트웨어 개발의 레고 모델이라고 생각하고 싶습니다. 각 구성 요소는 레고 블록으로 볼 수 있으며, 다양한 문제를 해결하면서 이 레고 블록을 여러 가지 방식으로 구성할 수 있습니다.</p> <p>해결하려는 문제는 노드가 상태를 계산하고 가장자리가 상태 간의 전환을 나타내는 그래프로 표현되는 워크플로로 표현할 수 있습니다. 이 그래프의 노드에 들어갈 때마다 입력을 살펴보고, 필요한 추가 데이터를 결정하고, 계산을 실행하고, 다음 상태로 전환합니다. 그래프의 각 노드는 특정 작업을 수행하는 레고 블록입니다. 이러한 노드는 데이터 흐름을 관리하는 코드 계층으로 연결됩니다.</p> <p>위의 아키텍처를 구현하는 한 가지 접근 방식은 <strong>맵을 사용하여 전체 상태를 설명한 다음, 각각 특정 유형의 상태에 대해 작동하는 다중 메서드를 통과하여 새로운 상태를 생성하는 것</strong>입니다. 각 멀티메서드는 상태 맵을 매개변수로 받아 몇 가지 연산을 수행한 다음 다음 멀티메서드에 전달되는 새 맵을 반환합니다. 이것이 상태 머신과 비슷하게 들린다고 생각하신다면 매우 정확합니다.</p> <p>This post will take a look at a strategy for structuring Clojure applications that I've found useful in my projects.</p> <p>While the idea of writing applications in a pure functional style is appealing, it's not always clear how to separate side effects from pure compuation in practice. Variations of <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html" target="_blank" rel="noopener noreferrer">Clean Architecture<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> approach are often suggested as a way to accomplish this goal. This style dictates that IO should be handled in the outer layer that wraps pure computation core of the application.</p> <p>While this notion is appealing, it only works in cases where the totality of the data that will be operated on is known up front. Unfortunately, it's impossible to know ahead of time what data will be needed in most real world applications. In many cases additional data needs to load conditionally based on the type of input and the current state of processing.</p> <p>What we can do, however, is break up our application into small components that can be reasoned about in isolation. Such components can then be composed together to accomplish tasks of increased complexity. I like to think of this as a Lego model of software development. Each component can be viewed as a Lego block, and we can compose these Lego block in many different ways as we solve different problems.</p> <p>The problem being solved can be expressed in terms of a workflow represented by a graph where the nodes compute the state, and the edges represent transitions between the states. Each time we enter a node in this graph, we look at the input, decide what additional data we may need, run the computation, and transition to the next state. Each node in the graph is a Lego block that accomplishes a particular task. These nodes are then connected by a layer of code governs the data flow.</p> <p>One approach to implement the above architecture is to use a map to describe overall state, then pass it through multimethods that each operate on a particular type of state and produce a new one. Each multimethod takes the state map as a parameter, does some operations on it, and then returns a new map that gets passed to the next multimethod. If you're thinking that this sounds a like a state machine then you're very much correct.</p> <h3 id="구현-implemention"><a href="#구현-implemention" class="header-anchor">#</a> 구현 (Implemention)</h3> <p>실제로 어떤 모습인지 구체적인 예를 살펴보겠습니다. 한 사용자가 시스템을 사용하여 다른 사용자에게 이메일 송금을 보내려는 워크플로우가 있다고 가정해 보겠습니다. 여기서 처리할 수 있는 몇 가지 경우가 있습니다.</p> <p>두 사용자가 모두 시스템에 있는 행복한 경로 시나리오가 있습니다. 이 경우 송금인 계좌에서 금액을 인출하여 수취인 계좌에 입금하기만 하면 됩니다.</p> <p>또 다른 시나리오는 송금인이 거래를 처리하기에 충분한 자금이 없는 경우입니다. 이 경우 사용자가 자금을 더 추가할 때까지 트랜잭션을 일시 중단할 수 있습니다.</p> <p>마지막으로, 송금을 받는 사용자가 시스템에 없을 수 있으며, 송금을 수락하기 전에 초대를 받아야 할 수도 있습니다.</p> <p>외부 리소스와의 상호작용을 나타내는 몇 가지 도우미 함수를 정의하는 것으로 시작할 수 있습니다.</p> <p>Let's take a look at a concrete example of what this looks like in practice. Say we have a workflow where one user would like to send an email money transfer to another user using our system. There are a few cases we might want to handle here.</p> <p>There's the happy path scenario where both users are in the system. In this case we simply withdraw the amount from the payor account and deposit it into the payee account.</p> <p>Another scenario could be that the payor does not have the sufficient funds to do the transaction. In this case we may want to suspend the transaction until the user adds more funds.</p> <p>Finally, the user receiving the funds may not be in the system, and they need to be invited before they can accept the transfer.</p> <p>We can start by defining a few helper functions that represent interactions with external resources.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">def</span> store <span class="token punctuation">(</span><span class="token function">atom</span> <span class="token punctuation">{</span><span class="token symbol">:workflows</span> <span class="token punctuation">{</span><span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span>
                              <span class="token punctuation">{</span><span class="token symbol">:id</span> <span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span>
                                <span class="token symbol">:from</span>   <span class="token punctuation">{</span><span class="token symbol">:email</span> <span class="token string">&quot;bob@foo.bar&quot;</span><span class="token punctuation">}</span>
                                <span class="token symbol">:to</span>     <span class="token punctuation">{</span><span class="token symbol">:email</span> <span class="token string">&quot;alice@bar.baz&quot;</span><span class="token punctuation">}</span>
                                <span class="token symbol">:amount</span> <span class="token number">200</span>
                                <span class="token symbol">:action</span> <span class="token symbol">:transfer</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                  <span class="token symbol">:users</span> <span class="token punctuation">{</span><span class="token string">&quot;bob@foo.bar&quot;</span> <span class="token punctuation">{</span><span class="token symbol">:funds</span> <span class="token number">100</span><span class="token punctuation">}</span>
                          <span class="token string">&quot;alice@bar.baz&quot;</span> <span class="token punctuation">{</span><span class="token symbol">:funds</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> persist <span class="token punctuation">[</span>store <span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token symbol">:as</span> state<span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">swap!</span> store assoc-in <span class="token punctuation">[</span><span class="token symbol">:workflows</span> id<span class="token punctuation">]</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> query <span class="token punctuation">[</span>store email<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">get-in</span> <span class="token operator">@</span>store <span class="token punctuation">[</span><span class="token symbol">:users</span> email<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> load-state <span class="token punctuation">[</span>store workflow-id<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">get-in</span> <span class="token operator">@</span>store <span class="token punctuation">[</span><span class="token symbol">:workflows</span> workflow-id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> send-invite <span class="token punctuation">[</span>email<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">&quot;sending invite to&quot;</span> email<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> notify-user <span class="token punctuation">[</span>email message<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">&quot;notifying&quot;</span> email message<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> send-transfer <span class="token punctuation">[</span>store from to amount<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">&quot;transfering from&quot;</span> from <span class="token string">&quot;to&quot;</span> to amount<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">swap!</span> store
          <span class="token operator">#</span><span class="token punctuation">(</span><span class="token keyword">-&gt;</span> %
              <span class="token punctuation">(</span><span class="token function">update-in</span> <span class="token punctuation">[</span><span class="token symbol">:users</span> from <span class="token symbol">:funds</span><span class="token punctuation">]</span> - amount<span class="token punctuation">)</span>
              <span class="token punctuation">(</span><span class="token function">update-in</span> <span class="token punctuation">[</span><span class="token symbol">:users</span> to <span class="token symbol">:funds</span><span class="token punctuation">]</span> + amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>다음으로 워크플로우의 초기 상태를 나타내는 맵을 만들어 보겠습니다.</p> <p>Next, we'll create a map to represent the initial state of the workfow.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">{</span><span class="token symbol">:id</span> <span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span>
  <span class="token symbol">:from</span>   <span class="token punctuation">{</span><span class="token symbol">:email</span> <span class="token string">&quot;bob@foo.bar&quot;</span><span class="token punctuation">}</span>
  <span class="token symbol">:to</span>     <span class="token punctuation">{</span><span class="token symbol">:email</span> <span class="token string">&quot;alice@bar.baz&quot;</span><span class="token punctuation">}</span>
  <span class="token symbol">:amount</span> <span class="token number">200</span>
  <span class="token symbol">:action</span> <span class="token symbol">:transfer</span><span class="token punctuation">}</span>
</code></pre></div><p>맵에는 고유 ID, 사용자 입력을 나타내는 초기 데이터, 워크플로우의 현재 상태에 어떤 작업을 적용해야 하는지를 나타내는 <code>:action</code> 키가 포함됩니다.</p> <p>이제 <code>:action</code> 키의 값에 따라 적절한 액션 핸들러를 디스패치하는 다중 메서드를 정의해 보겠습니다. 다중 메서드는 리소스 맵을 첫 번째 인수로 받습니다. 리소스는 데이터베이스 연결과 같은 IO 부작용을 처리하는 모든 코드를 나타냅니다. 워크플로우의 상태를 나타내는 맵은 두 번째 인수로 전달됩니다.</p> <p>The map will contain a unique id, some initial data that represents user input, and an <code>:action</code> key indicating what action should be applied to the current state of the workflow.</p> <p>Let's define a multimethod that will dispatch the approprate action handler based on the value of the <code>:action</code> key. The multimethod will accept a map of resources as the first argument. The resources represent any code that deals with IO side effects such as database connections. The map representing the state of the workflow will be passed in as the second argument.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">defmulti</span> handle-action <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span>_resources <span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span> action<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>이제 <code>:transfer</code> 작업에 대한 핸들러를 정의할 수 있습니다. 이 다중 메서드는 데이터스토어에서 사용자에 대한 추가 데이터를 가져와 적절한 조치를 취한 후 워크플로의 다음 단계를 나타내는 업데이트된 <code>:action</code> 키가 포함된 새 상태를 반환합니다.</p> <p>We can now define a handler for the <code>:transfer</code> operation. This multimethod will hydrate some additional data about the users from the datastore, take the appropriate action, and return a new state with the updated <code>:action</code> key to indicate the next step in the workflow.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">defmethod</span> handle-action <span class="token symbol">:transfer</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>store<span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>from to amount<span class="token punctuation">]</span> <span class="token symbol">:as</span> state<span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>from-info <span class="token punctuation">(</span><span class="token function">query</span> store <span class="token punctuation">(</span><span class="token symbol">:email</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
          to-info   <span class="token punctuation">(</span><span class="token function">query</span> store <span class="token punctuation">(</span><span class="token symbol">:email</span> to<span class="token punctuation">)</span><span class="token punctuation">)</span>
          available-funds <span class="token punctuation">(</span><span class="token symbol">:funds</span> from-info<span class="token punctuation">)</span>
          state     <span class="token punctuation">(</span><span class="token keyword">-&gt;</span> state
                        <span class="token punctuation">(</span><span class="token function">update</span> <span class="token symbol">:from</span> merge from-info<span class="token punctuation">)</span>
                        <span class="token punctuation">(</span><span class="token function">update</span> <span class="token symbol">:to</span> merge to-info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
      <span class="token punctuation">(</span><span class="token keyword">cond</span>
        <span class="token punctuation">(</span><span class="token keyword">nil?</span> to-info<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">assoc</span> state <span class="token symbol">:action</span> <span class="token symbol">:invite</span><span class="token punctuation">)</span> 
        <span class="token punctuation">(</span><span class="token keyword">&gt;=</span> available-funds amount<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">do</span>
          <span class="token punctuation">(</span><span class="token function">send-transfer</span> store <span class="token punctuation">(</span><span class="token symbol">:email</span> from<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token symbol">:email</span> to<span class="token punctuation">)</span> amount<span class="token punctuation">)</span>
          <span class="token punctuation">(</span><span class="token keyword">assoc</span> state <span class="token symbol">:action</span> <span class="token symbol">:done</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">&lt;</span> available-funds amount<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">assoc</span> state <span class="token symbol">:action</span> <span class="token symbol">:notify-missing-funds</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><code>:invite</code> 및 <code>:notify-missing-funds</code> 액션에 대한 핸들러를 추가해 보겠습니다.</p> <p>Let's add the handlers for <code>:invite</code> and <code>:notify-missing-funds</code> actions.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">defmethod</span> handle-action <span class="token symbol">:notify-missing-funds</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>store<span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>from<span class="token punctuation">]</span> <span class="token symbol">:as</span> state<span class="token punctuation">}</span><span class="token punctuation">]</span> 
  <span class="token punctuation">(</span><span class="token function">notify-user</span> <span class="token punctuation">(</span><span class="token symbol">:email</span> from<span class="token punctuation">)</span> <span class="token string">&quot;missing funds&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">persist</span> store <span class="token punctuation">(</span><span class="token keyword">assoc</span> state <span class="token symbol">:action</span> <span class="token symbol">:transfer</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token symbol">:action</span> <span class="token symbol">:await</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defmethod</span> handle-action <span class="token symbol">:invite</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>store<span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>to<span class="token punctuation">]</span> <span class="token symbol">:as</span> state<span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">send-invite</span> to<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">persist</span> store <span class="token punctuation">(</span><span class="token keyword">assoc</span> state <span class="token symbol">:action</span> <span class="token symbol">:transfer</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token symbol">:action</span> <span class="token symbol">:await</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>:invite</code> 및 <code>:notify-missing-funds</code>  액션은 상태를 유지하고 완료되면 <code>:await</code> 액션을 반환한다는 점에 유의하세요. 이 동작을 사용하여 워크플로가 외부 액션에 의해 차단되어 일시 중단되어야 함을 나타냅니다.</p> <p>마지막으로 상태 머신을 실행하는 함수를 추가하겠습니다. 이 함수는 워크플로우 ID와 함께 리소스가 포함된 맵을 받습니다. 이 함수는 현재 상태를 로드하고 위에서 정의한 다중 메서드를 디스패치하여 실행합니다.</p> <p>Note that <code>:invite</code> and <code>:notify-missing-funds</code> actions persist the state and return the <code>:await</code> action when they complete. We'll use this behavior to indicate that the workflow is blocked on an external action and needs to be suspended.</p> <p>Finally, we'll add a function that executes the state machine. This function will accept a map containing the resources along with a workflow id. It will load the current state and execute it by dispatching the multimethod defined above.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">defn</span> run-workflow
  <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>store<span class="token punctuation">]</span> <span class="token symbol">:as</span> resources<span class="token punctuation">}</span> workflow-id<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">loop</span> <span class="token punctuation">[</span>state <span class="token punctuation">(</span><span class="token function">load-state</span> store workflow-id<span class="token punctuation">)</span><span class="token punctuation">]</span> 
    <span class="token punctuation">(</span><span class="token function">condp</span> = <span class="token punctuation">(</span><span class="token keyword">-&gt;</span> state <span class="token symbol">:action</span><span class="token punctuation">)</span>
      <span class="token symbol">:done</span> state
      <span class="token symbol">:await</span> <span class="token symbol">:workflow-suspended</span>
      <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>state <span class="token punctuation">(</span><span class="token function">handle-action</span> resources state<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">(</span><span class="token keyword">recur</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>간단하게 설명하기 위해 원자(atom) 하나를 모의 데이터 저장소로 사용하겠습니다.</p> <p>For simplicity's sake let's use an atom as our mock data store.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">def</span> store <span class="token punctuation">(</span><span class="token function">atom</span> <span class="token punctuation">{</span><span class="token symbol">:workflows</span> <span class="token punctuation">{</span><span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span>
                              <span class="token punctuation">{</span><span class="token symbol">:id</span> <span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span>
                                <span class="token symbol">:from</span>   <span class="token punctuation">{</span><span class="token symbol">:email</span> <span class="token string">&quot;bob@foo.bar&quot;</span><span class="token punctuation">}</span>
                                <span class="token symbol">:to</span>     <span class="token punctuation">{</span><span class="token symbol">:email</span> <span class="token string">&quot;alice@bar.baz&quot;</span><span class="token punctuation">}</span>
                                <span class="token symbol">:amount</span> <span class="token number">200</span>
                                <span class="token symbol">:action</span> <span class="token symbol">:transfer</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                  <span class="token symbol">:users</span> <span class="token punctuation">{</span><span class="token string">&quot;bob@foo.bar&quot;</span> <span class="token punctuation">{</span><span class="token symbol">:funds</span> <span class="token number">100</span><span class="token punctuation">}</span>
                          <span class="token string">&quot;alice@bar.baz&quot;</span> <span class="token punctuation">{</span><span class="token symbol">:funds</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>이제 REPL에서 이 워크플로를 실행해 볼 수 있습니다. 초기 상태로 실행하면 송금할 자금이 부족하여 워크플로우가 일시 중단된 것을 볼 수 있습니다.</p> <p>We can now try running this workflow in the REPL. If we run it with the initial state, then we should see that the workflow was suspended because there were insufficient funds to transfer.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code>=&gt; <span class="token punctuation">(</span><span class="token function">run-workflow</span> <span class="token punctuation">{</span><span class="token symbol">:store</span> store<span class="token punctuation">}</span> <span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span><span class="token punctuation">)</span>

notifying bob<span class="token operator">@</span>foo.bar missing funds
<span class="token symbol">:workflow-suspended</span>
</code></pre></div><p>워크플로에서 누락된 자금과 반환을 사용자에게 알리려고 시도합니다. 송금하려는 계정에 자금을 더 추가해 보겠습니다.</p> <p>The workflow tries to notify the user of the missing funds and returns. Let's add more funds to the account trying to send the transfer.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code>=&gt; <span class="token punctuation">(</span><span class="token function">swap!</span> store assoc-in <span class="token punctuation">[</span><span class="token symbol">:users</span> <span class="token string">&quot;bob@foo.bar&quot;</span> <span class="token symbol">:funds</span><span class="token punctuation">]</span> <span class="token number">300</span><span class="token punctuation">)</span>
</code></pre></div><p>워크플로가 중단된 지점부터 다시 시작되어 전송이 성공적으로 완료됩니다.</p> <p>The workflow restarts where it left off and completes the transfer successfully.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code>=&gt; <span class="token punctuation">(</span><span class="token function">run-workflow</span> <span class="token punctuation">{</span><span class="token symbol">:store</span> store<span class="token punctuation">}</span> <span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span><span class="token punctuation">)</span>

transfering from bob<span class="token operator">@</span>foo.bar to alice<span class="token operator">@</span>bar.baz <span class="token number">200</span>
<span class="token punctuation">{</span><span class="token symbol">:id</span> <span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span><span class="token punctuation">,</span>
  <span class="token symbol">:from</span> <span class="token punctuation">{</span><span class="token symbol">:email</span> <span class="token string">&quot;bob@foo.bar&quot;</span><span class="token punctuation">,</span> <span class="token symbol">:funds</span> <span class="token number">300</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token symbol">:to</span> <span class="token punctuation">{</span><span class="token symbol">:email</span> <span class="token string">&quot;alice@bar.baz&quot;</span><span class="token punctuation">,</span> <span class="token symbol">:funds</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token symbol">:amount</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token symbol">:action</span> <span class="token symbol">:done</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="사이드이팩트-정형화하기-formalizing-side-effects"><a href="#사이드이팩트-정형화하기-formalizing-side-effects" class="header-anchor">#</a> 사이드이팩트 정형화하기 (Formalizing Side Effects)</h3> <p>프로토콜을 사용하여 리소스 제공자를 공식화함으로써 위의 구현을 한 단계 더 개선할 수 있습니다. 이렇게 하면 외부 의존성이 무엇인지 명확해지고 모킹이 쉬워집니다. 다음과 같이 <code>Notify</code>와 <code>DataStore</code> 프로토콜을 만들어 봅시다.</p> <p>We can make one futher improvement over the implementation above by formalizing resource providers using protocols. Doing so will make it clear what the external dependecies are and facilitate mocking. Let's create <code>Notify</code> and <code>DataStore</code> protocols that look as follows.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">defprotocol</span> Notify
  <span class="token punctuation">(</span><span class="token function">send-invite</span> <span class="token punctuation">[</span>email<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">notify-user</span> <span class="token punctuation">[</span>email message<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defprotocol</span> DataStore
  <span class="token punctuation">(</span><span class="token function">persist</span> <span class="token punctuation">[</span>_ state<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">query</span> <span class="token punctuation">[</span>_ email<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">add-funds</span> <span class="token punctuation">[</span>_ email amount<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">load-state</span> <span class="token punctuation">[</span>_ workflow-id<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">send-transfer</span> <span class="token punctuation">[</span>_ from to amount<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>다음으로 이러한 프로토콜을 구현하는 몇 가지 레코드를 추가해 보겠습니다.</p> <p>Next, let's add a couple of records that implement these protocols.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">defrecord</span> MockNotify <span class="token punctuation">[</span><span class="token punctuation">]</span>
  Notify
  <span class="token punctuation">(</span><span class="token function">send-invite</span> <span class="token punctuation">[</span>_ email<span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">&quot;sending invite to&quot;</span> email<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">notify-user</span> <span class="token punctuation">[</span>_ email message<span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">&quot;notifying&quot;</span> email message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defrecord</span> AtomDataStore <span class="token punctuation">[</span>store<span class="token punctuation">]</span>
  DataStore
  <span class="token punctuation">(</span><span class="token function">persist</span> <span class="token punctuation">[</span>_ <span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token symbol">:as</span> state<span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token function">swap!</span> store assoc-in <span class="token punctuation">[</span><span class="token symbol">:workflows</span> id<span class="token punctuation">]</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">query</span> <span class="token punctuation">[</span>_  email<span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token function">get-in</span> <span class="token operator">@</span>store <span class="token punctuation">[</span><span class="token symbol">:users</span> email<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">add-funds</span> <span class="token punctuation">[</span>_ email amount<span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token function">swap!</span> store assoc-in <span class="token punctuation">[</span><span class="token symbol">:users</span> <span class="token string">&quot;bob@foo.bar&quot;</span> <span class="token symbol">:funds</span><span class="token punctuation">]</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">load-state</span> <span class="token punctuation">[</span>_ workflow-id<span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">get-in</span> <span class="token operator">@</span>store <span class="token punctuation">[</span><span class="token symbol">:workflows</span> workflow-id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">send-transfer</span> <span class="token punctuation">[</span>_ from to amount<span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">&quot;transfering from&quot;</span> from <span class="token string">&quot;to&quot;</span> to amount<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">swap!</span> store
            <span class="token operator">#</span><span class="token punctuation">(</span><span class="token keyword">-&gt;</span> %
                <span class="token punctuation">(</span><span class="token function">update-in</span> <span class="token punctuation">[</span><span class="token symbol">:users</span> from <span class="token symbol">:funds</span><span class="token punctuation">]</span> - amount<span class="token punctuation">)</span>
                <span class="token punctuation">(</span><span class="token function">update-in</span> <span class="token punctuation">[</span><span class="token symbol">:users</span> to <span class="token symbol">:funds</span><span class="token punctuation">]</span> + amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>또한 앞에서 정의한 함수를 단순히 호출하는 대신 'Notify' 프로토콜을 사용하도록 멀티 메서드를 수정해야 합니다.</p> <p>We'll also need to modify our multimethods to use <code>Notify</code> protocol instead of simply calling the functions we defined earlier.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">defmethod</span> handle-action <span class="token symbol">:notify-missing-funds</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>store notify<span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>from<span class="token punctuation">]</span> <span class="token symbol">:as</span> state<span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">notify-user</span> notify <span class="token punctuation">(</span><span class="token symbol">:email</span> from<span class="token punctuation">)</span> <span class="token string">&quot;missing funds&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">persist</span> store <span class="token punctuation">(</span><span class="token keyword">assoc</span> state <span class="token symbol">:action</span> <span class="token symbol">:transfer</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token symbol">:action</span> <span class="token symbol">:await</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defmethod</span> handle-action <span class="token symbol">:invite</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>store notify<span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>to<span class="token punctuation">]</span> <span class="token symbol">:as</span> state<span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">send-invite</span> notify to<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">persist</span> store <span class="token punctuation">(</span><span class="token keyword">assoc</span> state <span class="token symbol">:action</span> <span class="token symbol">:transfer</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token symbol">:action</span> <span class="token symbol">:await</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>마지막으로 레코드를 인스턴스화하여 '실행 워크플로' 함수에 전달합니다.</p> <p>Finally, we'll instantiate the records and passing them to our <code>run-workflow</code> function.</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">def</span> store <span class="token punctuation">(</span><span class="token function">-&gt;AtomDataStore</span> <span class="token punctuation">(</span><span class="token function">atom</span> <span class="token punctuation">{</span><span class="token symbol">:workflows</span> <span class="token punctuation">{</span><span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span>
                                                <span class="token punctuation">{</span><span class="token symbol">:id</span> <span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span>
                                                <span class="token symbol">:from</span>   <span class="token punctuation">{</span><span class="token symbol">:email</span> <span class="token string">&quot;bob@foo.bar&quot;</span><span class="token punctuation">}</span>
                                                <span class="token symbol">:to</span>     <span class="token punctuation">{</span><span class="token symbol">:email</span> <span class="token string">&quot;alice@bar.baz&quot;</span><span class="token punctuation">}</span>
                                                <span class="token symbol">:amount</span> <span class="token number">200</span>
                                                <span class="token symbol">:action</span> <span class="token symbol">:transfer</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                                    <span class="token symbol">:users</span> <span class="token punctuation">{</span><span class="token string">&quot;bob@foo.bar&quot;</span> <span class="token punctuation">{</span><span class="token symbol">:funds</span> <span class="token number">100</span><span class="token punctuation">}</span>
                                            <span class="token string">&quot;alice@bar.baz&quot;</span> <span class="token punctuation">{</span><span class="token symbol">:funds</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">def</span> notify <span class="token punctuation">(</span><span class="token function">-&gt;MockNotify</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">run-workflow</span> <span class="token punctuation">{</span><span class="token symbol">:store</span> store
                <span class="token symbol">:notify</span> notify<span class="token punctuation">}</span> 
              <span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">add-funds</span> store <span class="token string">&quot;bob@foo.bar&quot;</span> <span class="token number">100</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">run-workflow</span> <span class="token punctuation">{</span><span class="token symbol">:store</span> store
                <span class="token symbol">:notify</span> notify<span class="token punctuation">}</span> 
              <span class="token string">&quot;33a19b1f-c7d1-45d8-9864-0ea17e01a26d&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="토론-discussion"><a href="#토론-discussion" class="header-anchor">#</a> 토론(Discussion)</h3> <p>위의 접근 방식에는 애플리케이션을 구축할 때 특히 유용하다고 생각되는 몇 가지 측면이 있습니다.</p> <p>각각의 다중 메서드는 독립적으로 추론하고 테스트할 수 있는 작은 프로그램으로 취급할 수 있습니다. 이러한 다중 메서드는 클린 아키텍처 스타일을 사용하여 에지에 IO를 유지하면서 쉽게 구조화할 수 있습니다.</p> <p>리소스를 명시적 파라미터로 전달하면 계산에서 IO를 분리할 수 있습니다. 이 설계는 데이터 저장소와 같은 리소스가 명시적으로 전달되므로 테스트에 적합합니다. 나머지 코드를 변경하지 않고도 테스트를 실행할 때 모의 리소스 맵을 전달할 수 있습니다. 실제로 모의 리소스를 대상으로 개발을 시작하고 데이터베이스나 다른 시스템에 연결하는 것에 대해 걱정할 필요 없이 워크플로 로직이 의도한 대로 작동하는지 확인할 수 있습니다.</p> <p>맵을 사용하여 실행 상태를 추적하면 쉽게 검사할 수 있습니다. 이 맵을 기록하여 어떤 작업을 수행 중인지, 데이터가 어떻게 보이는지 등을 확인할 수 있습니다. 또한 상태를 쉽게 직렬화할 수 있으므로 필요에 따라 연산을 일시 중단했다가 다시 시작할 수 있습니다. 이는 앞서 살펴본 것처럼 외부 작업을 기다리는 동안 워크플로를 일시 중단해야 하는 경우에 특히 유용합니다.</p> <p>이 설계는 스테이트풀 리소스를 포함하는 시스템 맵을 관리하는 데 사용할 수 있는 Integrant와도 잘 어울립니다.</p> <p>가장 중요한 점은 이러한 유형의 아키텍처는 암시적 결합 없이 재사용 가능한 구성 요소를 생성한다는 것입니다. 각 멀티메소드는 다른 멀티메소드와 독립적으로 사용할 수 있으며, 서로 다른 워크플로로 구성할 수 있습니다. 이를 통해 더 큰 구조를 구축하는 데 사용할 수 있는 컴포저블(조합가능한) 레고 블록을 얻을 수 있습니다.</p> <blockquote><p><a href="https://github.com/weavejester/integrant" target="_blank" rel="noopener noreferrer">Integrant<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: Integrant는 데이터 기반 아키텍처로 애플리케이션을 구축하기 위한 Clojure(및 ClojureScript) 마이크로 프레임워크입니다. 컴포넌트 또는 마운트의 대안으로 생각할 수 있으며, Arachne에서 영감을 받아 Duct 작업을 통해 만들어졌습니다. Integrant is a Clojure (and ClojureScript) micro-framework for building applications with data-driven architecture. It can be thought of as an alternative to Component or Mount, and was inspired by Arachne and through work on Duct.</p></blockquote> <p>There are several aspects of the above approach that I've found to be particularly useful when building applications.</p> <p>Each multimethod can be treated as a small program that can be reasoned about and tested independently. These multimethods can easily be structured using Clean Architecture style keepng IO at the edges.</p> <p>Passing resources in as an explicit parameter allows decoupling IO from computation. This design lends itself well to testing since resources, such as the data store, are passed in explicitly. We can pass in a map of mock resources when running tests without any changes to the rest of the code. In fact, we can start developing against mock resources and ensure that the workflow logic works as intended before having to worry about connecting to databases or other systems.</p> <p>Using a map to track the state of the execution makes it easy to inspect it. We can log this map to see what operation we're doing, what the data looks like, and so on. The state can also be easily serialized, allowing us to suspend and resume computation as needed. This is particularly useful in cases when the workflow needs to be suspended pending some external action as we saw earlier.</p> <p>This design also plays well with Integrant which can be used to manage the system map containing stateful resources.</p> <p>Most importantly, this type of architecture creates reusable components without implicit coupling. Each multimethod can be used indepenently of the others, and composed into different workflows. This gives us composable Lego blocks that we can use to build larger structures.</p> <ul><li>원문: <a href="https://yogthos.net/posts/2022-12-18-StructuringClojureApplications.html" target="_blank" rel="noopener noreferrer">Structuring Clojure Applications<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/clojure/columns/Advantages_Of_Data_Oriented_Programming.html" class="prev">
        데이터 지향 프로그래밍의 장점
      </a></span> <span class="next"><a href="/clojure/talks/Hickey_Rich/AreWeThereYet_ko.html">
        우리는 거기에 있는가? (Are We There Yet?)
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e020f7bd.js" defer></script><script src="/assets/js/8.f8a27090.js" defer></script><script src="/assets/js/47.f22eedc4.js" defer></script>
  </body>
</html>
